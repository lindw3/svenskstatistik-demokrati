---
title: "Svensk statistik - demokrati"
author: "av William Lind"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    navbar:
      - { title: "Till startsidan", href: "https://lindw3.github.io/svenskstatistik/", align: right }
    vertical_layout: fill
    theme: journal
    css: styles.css
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(stringr)
library(scales)
library(dplyr)
library(tidyr)
library(DT)
library(png)
library(data.table)
library(magrittr)
library(gridExtra)
library(openxlsx)
library(patchwork)
library(ggthemes)
library(plotly)
library(ggridges)
library(forecast)
library(GGally)
library(cluster)
library(sf)
library(ggrepel)
library(ggtext)

# Karta
data <- st_read("C:\\Users\\WILIDF17\\OneDrive - Sveriges Riksidrottsförbund\\Dokument\\GitHub\\svenskstatistik-demokrati\\data\\RegSO_2018_v2.gpkg" , layer = "RegSO_2018_v2")
kommuner_karta <- data %>%
  select(regso, kommunnamn, geom)
colnames(kommuner_karta) <- c("RegSO" , "Kommun" , "geom")
rm(data)



### Dataprep

# Valdeltagande riksdagsval
library(readxl)
valdeltagande <- read_excel("data/valdeltagande.xlsx")

# Valresultat i riksdagsval
valresultat_sverige <- read_excel("data/valresultat_sverige.xlsx", 
                                         col_types = c("text", "numeric", "numeric", 
                                                       "numeric", "numeric", "numeric", 
                                                       "numeric", "numeric", "numeric", 
                                                       "numeric"))
# Valresultat i EU-val
valresultat_eu <- read_excel("data/valresultat_eu.xlsx", 
     col_types = c("text", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric"))

# Valresultat i kommunval
valresultat_kommun <- read_excel("data/valresultat_kommun.xlsx", 
     col_types = c("text", "text", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric"))
valresultat_kommun <- valresultat_kommun %>% 
  pivot_longer(!c(Kommun, Parti) , names_to = "År" , values_to = "Andel") %>%
  filter(!(Parti %in% c("ogiltiga valsedlar" , "ej röstande"))) %>% 
  mutate(Färg = ifelse(Parti %in% c("Moderaterna", "Liberalerna", "Kristdemokraterna", "Sverigedemokraterna"), "Blå", "Röd")) %>% 
  mutate(Kommun = substr(Kommun, 6, nchar(Kommun)))

   # Dela upp i röd och blå för kartan
df <- valresultat_kommun %>% 
  filter(År == "2022") %>% 
  group_by(Kommun , Färg) %>% 
  reframe(Andel = sum(Andel)) %>% 
  group_by(Kommun) %>%
  filter(Andel != min(Andel)) %>%
  ungroup()

kommuner_karta <- kommuner_karta %>% 
  left_join(df %>% select(Kommun, Färg , Andel), by = "Kommun")


# Tema
ss_theme <- theme(plot.background = element_rect(fill = "#EB6864") ,
                  plot.caption = element_text(hjust = 0) ,
                  panel.background = element_rect(fill = "white"),
                  axis.line.x = element_line(color = "black" , linewidth = 0.75) ,
                  axis.line.y = element_line(color = "black" , linewidth = 0.75) ,
                  plot.title = element_text(color = "white" , size = 16 , family = "sans"),
                  panel.grid.major.y  = element_line(color = "#B51E17" , linetype = "dotted"),
                  panel.grid.major.x = element_line(NULL),
                  panel.grid.minor = element_line(NULL),
                  legend.background = element_rect(fill = "white"),
                  legend.key = element_rect(fill = "white"),
                  legend.text = element_text(color = "black" , family = "sans") ,
                  legend.title = element_text(color = "black" , family = "sans") , 
                  text = element_text(size=12, face="plain", color = "white" , family = "sans"),
                  axis.title = element_text(color = "white" , family = "sans" , size = 18),
                  axis.text = element_text(color = "white" , family = "sans") ,
                  axis.text.x = element_text(size = 12))

# Partifärger
partifärger <- scale_colour_manual(values = c("Centerpartiet" = "#009933" ,
                                              "Feministiskt initiativ" = "#CD1B68" ,
                                              "Kristdemokraterna" = "#000077" ,
                                              "Liberalerna" = "#006AB3" ,
                                              "Miljöpartiet" = "#83CF39" ,
                                              "Moderaterna" = "#52BDEC" ,
                                              "Piratpartiet" = "#572B85" ,
                                              "Socialdemokraterna" = "#E8112d" , 
                                              "Sverigedemokraterna" = "#DDDD00" ,
                                              "Vänsterpartiet" = "#DA291C" ,
                                              "Junilistan" = "#ff8c00" ,
                                              "Övriga partier" = "grey"))
```

# Översikt {data-orientation="rows"}
##
### Om initiativet
*Svensk statistik* är ett initiativ taget av William Lind med det huvudsakliga syftet att visualisera utvecklingen i Sverige utifrån ett antal parametrar. Genom SCB är Sverige ett land som ligger i framkant i att lagra registerdata och föra annan statistik på befolkningsnivå, men denna statistik är inte alltid så enkel att ta till sig. Detta är ett försök att förenkla möjligheten att ta till sig av denna data.
<br><br>

##
### Om rapporten 
I denna rapport bemöts området **Demokrati** utifrån dessa områden:
<br><br>
* **Val**: Valdeltagande och valresultat över tid. <br>
* **Partisympatier**: Partisympatier utifrån kön, ålder, utbildningsnivå, inkomst och bakgrund. <br>
* **Förtroendevalda**: Förtroendevalda utifrån kön, ålder, utbildningsnivå, inkomst och bakgrund.
<br> <br>
Använd navigationspanelen högst upp för att se svaren utifrån olika områden. *Får figurerna inte plats på sidan? Testa att zooma ut genom att hålla in `Ctrl` + `-`.*


##
### Andra områden
<style>
  .big-button {
    font-size: 30px;
    padding: 20px 40px;
  }
</style>


<div style="display: flex; gap: 15px; justify-content: left;">
  <a href="https://lindw3.github.io/svenskstatistik-demokrati/" class="btn btn-primary big-button" role="button">ARBETE</a>
  <a href="https://lindw3.github.io/svenskstatistik-demokrati/" class="btn btn-primary big-button" role="button">UTBILDNING</a>
</div>






# Val {data-orientation="columns"}
##  {.tabset .tabset-pills data-width="400"}
### Valdeltagande
```{r}
df <- valdeltagande %>% 
  pivot_longer(!Val, names_to = "År", values_to = "Andel")

df %>%
  ggplot(aes(x = År, y = Andel, group = Val, color = Val,
             text = paste("År: ", År, "\nVal: " , Val , "\nAndel: ", Andel , "%"))) +
  geom_line(linewidth = 1) +
  scale_y_continuous(labels = percent_format(scale = 1), breaks = seq(0, 100, 25), limits = c(0, 100)) +
  scale_x_discrete(breaks = c("1973" , "2022")) +
  ss_theme +
  scale_color_manual(values = c("Riksdag" = "#006AB3",
                                "Region" = "#DA291C",
                                "Kommun" =  "#009933"))   -> p_valdeltagande

ggplotly(p_valdeltagande, tooltip = "text") %>%
  config(displayModeBar = F)
```


##  {.tabset .tabset-pills data-width="600"}

### Valresultat i Sverige
```{r}
df <- valresultat_sverige %>%
  pivot_longer(!År, names_to = "Parti", values_to = "Röster")

df %>%
  ggplot(aes(x = År, y = Röster, group = Parti, colour = Parti,
             text = paste("År: ", År, "\nParti: ", Parti, "\nRöster: ", Röster, "%"))) +
  geom_line(linewidth = 1) +
  scale_y_continuous(labels = percent_format(scale = 1), breaks = seq(0, 50, 5), limits = c(0, 50)) +
  scale_x_discrete(breaks = c("1973" , "2022")) +
  ss_theme +
  partifärger -> p_valresultat_sverige

ggplotly(p_valresultat_sverige, tooltip = "text") %>%
  config(displayModeBar = F) %>%
  layout(legend = list(x = 1.05, y = 0.5, xanchor = "left", yanchor = "middle"))
```


### Valresultat i Europaval
```{r}
df <- valresultat_eu %>%
  pivot_longer(!År, names_to = "Parti", values_to = "Röster")

df %>%
  ggplot(aes(x = År, y = Röster, group = Parti, colour = Parti,
             text = paste("År: ", År, "\nParti: ", Parti, "\nRöster: ", Röster, "%"))) +
  geom_line(linewidth = 1) +
  scale_y_continuous(labels = percent_format(scale = 1), breaks = seq(0, 30, 5), limits = c(0, 30)) +
  scale_x_discrete(breaks = c("1995" , "2024")) +
  ss_theme +
  partifärger -> p_valresultat_eu

ggplotly(p_valresultat_eu, tooltip = "text") %>%
  config(displayModeBar = F) %>%
  layout(legend = list(x = 1.05, y = 0.5, xanchor = "left", yanchor = "middle")) 
```


### Valresultat i kommunval efter block
```{r}
kommuner_karta %>% 
ggplot(aes(text = paste(Kommun , "\nPolitisk färg: " , Färg , "\nAndel: " , Andel))) +
  geom_sf(aes(fill = Färg)) +
  ss_theme +
  scale_fill_manual(values = c("Blå" = "#006AB3" ,
                               "Röd" = "#DA291C") , labels = c("Höger" , "Vänster")) +
  labs(fill = "Partisympati efter block") +
  theme(panel.grid.major = NULL,
        panel.grid.minor = NULL, 
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) -> p_kommunval

p_kommunval
```












# Partisympatier efter kön {data-navmenu="Partisympatier"}
## {.tabset .tabset-pills}

### Partisympatier efter kön
SENASTE VALET, STAPELDIAGRAM DODGE, MÄN + KVINNOR

### Vänster/högersympatier efter kön
TIDSLINJE MED UPPDELNING VÄNSTER/HÖGER DÄR 50/50 RÖSTER. 0 = 100 % RÖSTAR VÄNSTER, 100 = 100 % RÖSTAR HÖGER.
EN LINJE FÖR MÄN OCH EN FÖR KVINNOR
EV. EN LINJE PER ÅLDERSGRUPP + TVÅ TJOCKARE LINJER FÖR MÄN RESPEKTIVE KVINNOR SOM HELHET



# Partisympatier efter ålder {data-navmenu="Partisympatier"}
## {.tabset .tabset-pills}

### Partisympatier efter ålderskategorier
SENASTE VALET, STAPELDIAGRAM DODGE, ÅLDERSKATEGORIERNA

### Vänster/högersympatier efter ålder, tidslinje
TIDSLINJE MED UPPDELNING VÄNSTER/HÖGER DÄR 50/50 RÖSTER. 0 = 100 % RÖSTAR VÄNSTER, 100 = 100 % RÖSTAR HÖGER.
EN LINJE PER ÅLDERSKATEGORI

### Vänster/högersympatier efter ålder och kön
SENASTE VALET, STAPELDIAGRAM STACKED, SEPARATA FÄRGER FÖR ÅLDERSKATEGORI + KÖN. WAFFLE CHART?





# Partisympatier efter utbildning {data-navmenu="Partisympatier"}
## {.tabset .tabset-pills}

### Partisympatier efter utbildningsbakgrund
SENASTE VALET, STAPELDIAGRAM DODGE, UTBILDNINGSBAKGRUND

### Vänster/högersympatier efter utbildningsbakgrund, tidslinje
TIDSLINJE MED UPPDELNING VÄNSTER/HÖGER DÄR 50/50 RÖSTER. 0 = 100 % RÖSTAR VÄNSTER, 100 = 100 % RÖSTAR HÖGER.
EN LINJE PER KATEGORI


### Vänster/högersympatier efter utbildningsbakgrund och kön
SENASTE VALET, STAPELDIAGRAM STACKED, SEPARATA FÄRGER FÖR VARJE KATEGORI + KÖN. WAFFLE CHART?






# Partisympatier efter inkomst {data-navmenu="Partisympatier"}
## {.tabset .tabset-pills}

### Partisympatier efter inkomstpercentil
SENASTE VALET, STAPELDIAGRAM DODGE, INKOMSTPERCENTIL

### Vänster/högersympatier efter inkomstpercentil, tidslinje
TIDSLINJE MED UPPDELNING VÄNSTER/HÖGER DÄR 50/50 RÖSTER. 0 = 100 % RÖSTAR VÄNSTER, 100 = 100 % RÖSTAR HÖGER.
EN LINJE PER KATEGORI


### Vänster/högersympatier efter inkomstpercentil och kön
SENASTE VALET, STAPELDIAGRAM STACKED, SEPARATA FÄRGER FÖR VARJE KATEGORI + KÖN. WAFFLE CHART?






# Partisympatier efter bakgrund {data-navmenu="Partisympatier"}
## {.tabset .tabset-pills}

### Partisympatier utifrån 
SENASTE VALET, STAPELDIAGRAM DODGE, SVENSK/UTLÄNDSK BAKGRUND

### Vänster/högersympatier efter inkomstpercentil, tidslinje
TIDSLINJE MED UPPDELNING VÄNSTER/HÖGER DÄR 50/50 RÖSTER. 0 = 100 % RÖSTAR VÄNSTER, 100 = 100 % RÖSTAR HÖGER.
EN LINJE PER KATEGORI


### Vänster/högersympatier efter inkomstpercentil och kön
SENASTE VALET, STAPELDIAGRAM STACKED, SEPARATA FÄRGER FÖR VARJE KATEGORI + KÖN. WAFFLE CHART?














# Förtroendevalda efter kön {data-navmenu="Förtroendevalda"}
##
###



